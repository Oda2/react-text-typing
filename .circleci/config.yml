version: 2.1

orbs:
  cypress: cypress-io/cypress@1.29.0

executors:
  with-chrome:
    docker:
      - image: 'cypress/browsers:node14.17.6-chrome100-ff98'

defaults: &defaults
  working_directory: ~/repo
  docker:
    - image: cimg/node:16.14.1

commands:
  install_js:
    steps:
      - run:
          name: Show environment
          command: |
            node --version
            yarn --version
      - run:
          name: Install dependencies
          command: yarn install

jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - install_js
      - run: yarn build
      - save_cache:
          paths:
            - dist
          key: v1-dependencies-{{ checksum "package.json" }}

  lint:
    <<: *defaults
    steps:
      - checkout
      - install_js
      - run: yarn lint
      - save_cache:
          paths:
            - node_modules
            - coverage
          key: v1-dependencies-{{ checksum "package.json" }}

  test:
    <<: *defaults
    steps:
      - checkout
      - install_js
      - run: yarn install
      - run: yarn coverage
      - run: yarn coveralls
      - save_cache:
          paths:
            - node_modules
            - coverage
          key: v1-dependencies-{{ checksum "package.json" }}

  deploy:
    <<: *defaults
    steps:
      - checkout
      - install_js
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - run:
          name: Authenticate with registry
          command: echo "//registry.npmjs.org/:_authToken=$npm_TOKEN" > ~/repo/.npmrc
      - run:
          name: Publish package
          command: npm publish

workflows:
  version: 2
  pipeline:
    jobs:
      - build
      - lint
      - test:
          requires:
            - build
            - lint
      - cypress/run:
          executor: with-chrome
          browser: chrome
          yarn: true
          start: yarn start
          wait-on: 'http://localhost:3000'
          no-workspace: true
          record: true
      - deploy:
          requires:
            - test
          filters:
            tags:
              only: /^*/
            branches:
              ignore: /.*/
      

notify:
  webhooks:
    - url: http://app.fossa.io/hooks/circleci